{% extends 'admin/base_site.html' %}
{% load static %}
{% block extrahead %}
  {{ block.super }}
  <meta charset="ISO-8859-1" />
  <style scoped>
    .receipt {
      background-color: #f8fafc;
      border-radius: 0.5rem;
    }
    
    .card-hover:hover {
      transform: translateY(-2px);
      transition: transform 0.2s ease;
      box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
    }
    
    .text-primary {
      color: #3b7ddd !important;
    }
    
    .bg-light {
      background-color: #f1f7ff !important;
    }
  </style>
{% endblock %}

{% block content %}
  <!-- Custom Tabs -->
  <div class="card w-100">
    <div class="card-header d-flex p-0">
      <h3 class="card-title p-3"><i class="fas fa-file"></i> Relatórios</h3>
      <ul class="nav nav-pills ml-auto p-2">
        <li class="nav-item">
          <a class="nav-link active" href="#tab_1" data-toggle="tab">Relatório Individual</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="#tab_2" data-toggle="tab">Relatório Geral</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="#tab_3" data-toggle="tab">Relatório Por Doador</a>
        </li>
      </ul>
    </div>
    <!-- /.card-header -->
    <div class="card-body">
      <div class="tab-content">
        <div class="tab-pane active" id="tab_1">
          <div class="row">
            <div class="col-md-3">
              <form method="get" action="#tab_1" class="filter-column" id="form_report_individual">
                <input type="hidden" name="report_type" value="individual" />
                {% if individual_form.non_field_errors %}
                  <div class="error help-block text-red">{{ individual_form.non_field_errors }}</div>
                {% endif %}

                {% for field in individual_form %}
                  <div class="mb-3">
                    <label class="form-label">{{ field.label }}</label>
                    {{ field }}

                    <div class="help-block text-red">
                      <ul class="errorlist">
                        {% for error in field.errors %}
                          <li>{{ error }}</li>
                        {% endfor %}
                      </ul>
                    </div>
                  </div>
                {% endfor %}
                <div class="mb-3">
                  <button class="btn btn-primary w-100" type="submit">Gerar Relatório</button>
                </div>
              </form>
            </div>

            <div class="col-md-9">
              <div class="receipt card border-0 shadow-sm" id="receipt_individual" style="max-height: 60vh; overflow-y: auto;">
                {% if summary_data.individual %}
                  <div class="report-summary p-4">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                      <h3 class="mb-0 text-primary"><i class="fas fa-file-alt mr-2"></i>{{ summary_data.individual.title }}</h3>
                      <span class="badge bg-light text-dark"><i class="fas fa-calendar-alt mr-1"></i>{{ summary_data.individual.periodo }}</span>
                    </div>

                    <div class="row g-3 mb-4">
                      <!-- Card de Total de Doações -->
                      <div class="col-md-6 col-lg-3">
                        <div class="card h-100 border-0 bg-light">
                          <div class="card-body text-center">
                            <h6 class="card-subtitle mb-2 text-muted">Total de Doações</h6>
                            <h3 class="card-title text-primary">{{ summary_data.individual.total_donations }}</h3>
                            <small class="text-muted">no período</small>
                          </div>
                        </div>
                      </div>

                      <!-- Card de Total Previsto -->
                      <div class="col-md-6 col-lg-3">
                        <div class="card h-100 border-0 bg-light">
                          <div class="card-body text-center">
                            <h6 class="card-subtitle mb-2 text-muted">Total Previsto</h6>
                            <h3 class="card-title text-info">{{ summary_data.individual.total_previsto }}</h3>
                            <small class="text-muted">valor estimado</small>
                          </div>
                        </div>
                      </div>

                      <!-- Card de Total Recebido -->
                      <div class="col-md-6 col-lg-3">
                        <div class="card h-100 border-0 bg-light">
                          <div class="card-body text-center">
                            <h6 class="card-subtitle mb-2 text-muted">Total Recebido</h6>
                            <h3 class="card-title text-success">{{ summary_data.individual.total_recebido }}</h3>
                            <small class="text-muted">valor confirmado</small>
                          </div>
                        </div>
                      </div>

                      <!-- Card de Diferença -->
                      <div class="col-md-6 col-lg-3">
                        <div class="card h-100 border-0 bg-light">
                          <div class="card-body text-center">
                            <h6 class="card-subtitle mb-2 text-muted">Diferença</h6>
                            <h3 class="card-title 
                              {% if summary_data.individual.dif_percentual|slice:'1:-1'|add:'0' >= 0 %}
                                
                                
                                text-success


                              {% else %}
                                
                                
                                text-danger


                              {% endif %}">
                              {{ summary_data.individual.dif_percentual }}
                            </h3>
                            <small class="text-muted">em relação ao previsto</small>
                          </div>
                        </div>
                      </div>
                    </div>

                    <form method="post" id="form_print_individual" class="mt-4">
                      {% csrf_token %}
                      <div class="d-flex justify-content-end">
                        <button class="btn btn-outline-primary" type="button" onclick="printReport('form_print_individual','form_report_individual')"><i class="fas fa-print me-2"></i> Imprimir Relatório</button>
                        <div id="printSpinner" class="spinner-border text-primary ms-2 d-none" role="status">
                          <span class="visually-hidden">Loading...</span>
                        </div>
                      </div>
                      <div id="printStatus" class="text-end small mt-2"></div>
                    </form>
                  </div>
                {% else %}
                  <div class="text-center p-5 text-muted">
                    <i class="fas fa-file-alt" style="font-size: 3rem;"></i>
                    <p class="mt-3">Nenhum relatório gerado. Selecione os filtros e clique em "Gerar Relatório".</p>
                  </div>
                {% endif %}
              </div>
            </div>
          </div>
        </div>
        <!-- /.tab-pane -->
        <div class="tab-pane" id="tab_2">
          <div class="row">
            <div class="col-md-3">
              <form method="get" action="#tab_2" class="filter-column" id="form_report_general">
                <input type="hidden" name="report_type" value="general" />

                {% if general_form.non_field_errors %}
                  <div class="error help-block text-red">{{ general_form.non_field_errors }}</div>
                {% endif %}

                {% for field in general_form %}
                  <div class="mb-3">
                    <label class="form-label">{{ field.label }}</label>
                    {{ field }}

                    <div class="help-block text-red">
                      <ul class="errorlist">
                        {% for error in field.errors %}
                          <li>{{ error }}</li>
                        {% endfor %}
                      </ul>
                    </div>
                  </div>
                {% endfor %}
                <div class="mb-3">
                  <button class="btn btn-primary w-100" type="submit">Gerar Relatório</button>
                </div>
              </form>
            </div>

            <div class="col-md-9">
              <div class="receipt card border-0 shadow-sm" id="receipt_general" style="max-height: 60vh; overflow-y: auto;">
                {% if summary_data.general %}
                  <div class="report-summary p-4">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                      <h3 class="mb-0 text-primary"><i class="fas fa-file-alt mr-2"></i>{{ summary_data.general.title }}</h3>
                      <span class="badge bg-light text-dark"><i class="fas fa-calendar-alt mr-1"></i>{{ summary_data.general.periodo }}</span>
                    </div>

                    <div class="row g-3 mb-4">
                      <!-- Card de Total de Doações -->
                      <div class="col-md-6 col-lg-3">
                        <div class="card h-100 border-0 bg-light">
                          <div class="card-body text-center">
                            <h6 class="card-subtitle mb-2 text-muted">Total de Doações</h6>
                            <h3 class="card-title text-primary">{{ summary_data.general.total_donations }}</h3>
                            <small class="text-muted">no período</small>
                          </div>
                        </div>
                      </div>

                      <!-- Card de Total Previsto -->
                      <div class="col-md-6 col-lg-3">
                        <div class="card h-100 border-0 bg-light">
                          <div class="card-body text-center">
                            <h6 class="card-subtitle mb-2 text-muted">Total Previsto</h6>
                            <h3 class="card-title text-info">{{ summary_data.general.total_previsto }}</h3>
                            <small class="text-muted">valor estimado</small>
                          </div>
                        </div>
                      </div>

                      <!-- Card de Total Recebido -->
                      <div class="col-md-6 col-lg-3">
                        <div class="card h-100 border-0 bg-light">
                          <div class="card-body text-center">
                            <h6 class="card-subtitle mb-2 text-muted">Total Recebido</h6>
                            <h3 class="card-title text-success">{{ summary_data.general.total_recebido }}</h3>
                            <small class="text-muted">valor confirmado</small>
                          </div>
                        </div>
                      </div>

                      <!-- Card de Diferença -->
                      <div class="col-md-6 col-lg-3">
                        <div class="card h-100 border-0 bg-light">
                          <div class="card-body text-center">
                            <h6 class="card-subtitle mb-2 text-muted">Diferença</h6>
                            <h3 class="card-title 
                              {% if summary_data.general.dif_percentual|slice:'1:-1'|add:'0' >= 0 %}
                                
                                
                                text-success


                              {% else %}
                                
                                
                                text-danger


                              {% endif %}">
                              {{ summary_data.general.dif_percentual }}
                            </h3>
                            <small class="text-muted">em relação ao previsto</small>
                          </div>
                        </div>
                      </div>
                    </div>

                    <form method="post" id="form_print_general" class="mt-4">
                      {% csrf_token %}
                      <div class="d-flex justify-content-end">
                        <button class="btn btn-outline-primary" type="button" onclick="printReport('form_print_general', 'form_report_general')"><i class="fas fa-print me-2"></i> Imprimir Relatório</button>
                        <div id="printSpinner" class="spinner-border text-primary ms-2 d-none" role="status">
                          <span class="visually-hidden">Loading...</span>
                        </div>
                      </div>
                      <div id="printStatus" class="text-end small mt-2"></div>
                    </form>
                  </div>
                {% else %}
                  <div class="text-center p-5 text-muted">
                    <i class="fas fa-file-alt" style="font-size: 3rem;"></i>
                    <p class="mt-3">Nenhum relatório gerado. Selecione os filtros e clique em "Gerar Relatório".</p>
                  </div>
                {% endif %}
              </div>
            </div>
          </div>
        </div>
        <!-- /.tab-pane -->
        <div class="tab-pane" id="tab_3">
          <div class="row">
            <div class="col-md-3">
              <form method="get" action="#tab_3" class="filter-column" id="form_report_donor">
                <input type="hidden" name="report_type" value="donor" />

                {% if donor_form.non_field_errors %}
                  <div class="error help-block text-red">{{ donor_form.non_field_errors }}</div>
                {% endif %}

                {% for field in donor_form %}
                  <div class="mb-3">
                    <label class="form-label">{{ field.label }}</label>
                    {{ field }}

                    <div class="help-block text-red">
                      <ul class="errorlist">
                        {% for error in field.errors %}
                          <li>{{ error }}</li>
                        {% endfor %}
                      </ul>
                    </div>
                  </div>
                {% endfor %}
                <div class="mb-3">
                  <button class="btn btn-primary w-100" type="submit">Gerar Relatório</button>
                </div>
              </form>
            </div>

            <div class="col-md-9">
              <div class="receipt card border-0 shadow-sm" id="receipt_donor" style="max-height: 60vh; overflow-y: auto;">
                {% if summary_data.donor %}
                  <div class="report-summary p-4">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                      <h3 class="mb-0 text-primary"><i class="fas fa-file-alt mr-2"></i>{{ summary_data.donor.title }}</h3>
                      <span class="badge bg-light text-dark"><i class="fas fa-calendar-alt mr-1"></i>{{ summary_data.donor.periodo }}</span>
                    </div>

                    <div class="row g-3 mb-4">
                      <!-- Card de Total de Doações -->
                      <div class="col-md-6 col-lg-3">
                        <div class="card h-100 border-0 bg-light">
                          <div class="card-body text-center">
                            <h6 class="card-subtitle mb-2 text-muted">Total de Doações</h6>
                            <h3 class="card-title text-primary">{{ summary_data.donor.total_donations }}</h3>
                            <small class="text-muted">no período</small>
                          </div>
                        </div>
                      </div>

                      <!-- Card de Total Previsto -->
                      <div class="col-md-6 col-lg-3">
                        <div class="card h-100 border-0 bg-light">
                          <div class="card-body text-center">
                            <h6 class="card-subtitle mb-2 text-muted">Total Previsto</h6>
                            <h3 class="card-title text-info">{{ summary_data.donor.total_previsto }}</h3>
                            <small class="text-muted">valor estimado</small>
                          </div>
                        </div>
                      </div>

                      <!-- Card de Total Recebido -->
                      <div class="col-md-6 col-lg-3">
                        <div class="card h-100 border-0 bg-light">
                          <div class="card-body text-center">
                            <h6 class="card-subtitle mb-2 text-muted">Total Recebido</h6>
                            <h3 class="card-title text-success">{{ summary_data.donor.total_recebido }}</h3>
                            <small class="text-muted">valor confirmado</small>
                          </div>
                        </div>
                      </div>

                      <!-- Card de Diferença -->
                      <div class="col-md-6 col-lg-3">
                        <div class="card h-100 border-0 bg-light">
                          <div class="card-body text-center">
                            <h6 class="card-subtitle mb-2 text-muted">Diferença</h6>
                            <h3 class="card-title 
                              {% if summary_data.donor.dif_percentual|slice:'1:-1'|add:'0' >= 0 %}
                                
                                
                                text-success


                              {% else %}
                                
                                
                                text-danger


                              {% endif %}">
                              {{ summary_data.donor.dif_percentual }}
                            </h3>
                            <small class="text-muted">em relação ao previsto</small>
                          </div>
                        </div>
                      </div>
                    </div>

                    <form method="post" id="form_print_donor" class="mt-4">
                      {% csrf_token %}
                      <div class="d-flex justify-content-end">
                        <button class="btn btn-outline-primary" type="button" onclick="printReport('form_print_donor','form_report_donor')"><i class="fas fa-print me-2"></i> Imprimir Relatório</button>
                        <div id="printSpinner" class="spinner-border text-primary ms-2 d-none" role="status">
                          <span class="visually-hidden">Loading...</span>
                        </div>
                      </div>
                      <div id="printStatus" class="text-end small mt-2"></div>
                    </form>
                  </div>
                {% else %}
                  <div class="text-center p-5 text-muted">
                    <i class="fas fa-file-alt" style="font-size: 3rem;"></i>
                    <p class="mt-3">Nenhum relatório gerado. Selecione os filtros e clique em "Gerar Relatório".</p>
                  </div>
                {% endif %}
              </div>
            </div>
          </div>
        </div>
        <!-- /.tab-pane -->
      </div>
      <!-- /.tab-content -->
    </div>
    <!-- /.card-body -->
  </div>
  <!-- ./card -->
{% endblock %}
{% block extrajs %}
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      const hash = window.location.hash
      if (hash) {
        const triggerEl = document.querySelector(`a[href="${hash}"]`)
        if (triggerEl) {
          new bootstrap.Tab(triggerEl).show()
        }
      }
    
      $('a[data-toggle="tab"]').on('shown.bs.tab', function (e) {
        var target = $(e.target).attr('href')
        history.replaceState(null, null, target)
      })
    })
    
    function abrirParaImprimir(id) {
      window.print()
    }
    
    function printReport(formVisualId, formDataId) {
      const formVisual = $('#' + formVisualId) // Formulário onde está o botão, spinner, status
      const formDataForm = $('#' + formDataId) // Formulário que vai ser enviado
    
      const button = formVisual.find('button[type="button"]')
      const spinner = formVisual.find('.spinner-border')
      const status = formVisual.find('.text-end.small')
    
      // Mostra o spinner e desabilita o botão
      spinner.removeClass('d-none')
      button.prop('disabled', true)
      status.text('Enviando para impressora...')
      status.attr('class', 'text-end small mt-2 text-primary')
    
      const formData = new FormData(formDataForm[0])
    
      $.ajax({
        url: "{% url 'admin:donation_print_receipt' %}",
        type: 'POST',
        data: formData,
        processData: false,
        contentType: false,
        headers: {
          'X-Requested-With': 'XMLHttpRequest',
          'X-CSRFToken': '{{ csrf_token }}'
        },
        success: function (data) {
          status.text('Relatório enviado para impressora com sucesso!')
          status.attr('class', 'text-end small mt-2 text-success')
        },
        error: function (xhr, statusText, errorThrown) {
          status.text('Erro ao enviar para impressora: ' + statusText)
          status.attr('class', 'text-end small mt-2 text-danger')
        },
        complete: function () {
          spinner.addClass('d-none')
          button.prop('disabled', false)
    
          setTimeout(function () {
            status.text('')
          }, 5000)
        }
      })
    }
  </script>

  <script>
    // Espera o DOM carregar e tenta de novo
  </script>

  <style scoped>
    .form-label {
      display: block;
      margin-bottom: 0.25rem;
      font-weight: 500;
    }
  </style>
{% endblock %}
